<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-color: #e8f4f8;
            --secondary-color: #f5f1ff;
            --accent-color: #a7c7e7;
            --text-color: #4a5568;
            --border-color: #e2e8f0;
            --success-color: #68d391;
            --error-color: #fc8181;
            --warning-color: #fbb86f;
            --button-hover: #9fb9d4;
            --background: #fafcff;
            --card-bg: #ffffff;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 30px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            font-weight: 300;
            color: #718096;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .file-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-upload-item {
            background: var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .file-upload-item:hover {
            border-color: var(--accent-color);
            background: rgba(167, 199, 231, 0.1);
        }

        .file-upload-item.uploaded {
            border-color: var(--success-color);
            background: rgba(104, 211, 145, 0.1);
        }

        .file-upload-item .file-info {
            text-align: center;
        }

        .file-upload-item .file-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .file-upload-item .file-description {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 15px;
        }

        .file-upload-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .file-upload-button:hover {
            background: var(--button-hover);
        }

        .file-upload-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .file-input {
            display: none;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .parameter-label {
            font-weight: 500;
            color: var(--text-color);
        }

        .parameter-select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .parameter-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .progress-section {
            margin: 40px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #718096;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--button-hover);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #48bb78;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px 15px 15px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            padding: 0;
            margin: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .notification-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .notification-copy {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            margin-right: 5px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .notification-copy:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-status {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--success-color);
            display: none;
        }

        .error-details {
            margin-top: 20px;
            padding: 15px;
            background: rgba(252, 129, 129, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--error-color);
            display: none;
        }

        .error-details h4 {
            color: var(--error-color);
            margin-bottom: 10px;
        }

        .error-list {
            list-style: none;
            color: #742a2a;
        }

        .error-list li {
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .error-list li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: var(--error-color);
        }

        .error-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(252, 129, 129, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--error-color);
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            display: none;
            z-index: 2000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .error-footer.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .error-footer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }

        .error-footer-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .error-footer-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .error-footer-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .error-footer-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            color: #742a2a;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 25vh;
            overflow-y: auto;
        }

        .error-footer-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .error-footer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .error-footer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px 15px 80px 15px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è footer */
            }

            .header h1 {
                font-size: 2rem;
            }

            .file-upload-grid {
                grid-template-columns: 1fr;
            }

            .parameters-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .error-footer {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ê–Ω–∞–ª–∏–∑ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç</h1>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞</p>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
        <div class="section">
            <div class="section-title">1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</div>
            <div class="file-upload-grid">
                <div class="file-upload-item" id="file1-area">
                    <div class="file-info">
                        <div class="file-title">–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                        <div class="file-description">CSV —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: –ò–º—è, –î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
                        <button class="file-upload-button" onclick="document.getElementById('file1').click()">
                            –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </button>
                        <input type="file" id="file1" class="file-input" accept=".csv" onchange="handleFileUpload(1, this)">
                        <div class="file-status" id="file1-status">‚úì –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    </div>
                </div>

                <div class="file-upload-item" id="file2-area">
                    <div class="file-info">
                        <div class="file-title">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</div>
                        <div class="file-description">XLSX —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: –§–ò–û, –ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π, –û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü, –í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤, –û—Ç–≥—É–ª—ã, –ò—Ç–æ–≥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü, –î–æ–ª–∂–Ω–æ—Å—Ç—å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ CSV)</div>
                        <button class="file-upload-button" onclick="document.getElementById('file2').click()">
                            –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </button>
                        <input type="file" id="file2" class="file-input" accept=".xlsx,.csv" onchange="handleFileUpload(2, this)">
                        <div class="file-status" id="file2-status">‚úì –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    </div>
                </div>

                <div class="file-upload-item" id="file3-area">
                    <div class="file-info">
                        <div class="file-title">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
                        <div class="file-description">XLSX —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: User, Description, Time (h), Time (decimal), Amount (RUB) (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ CSV)</div>
                        <button class="file-upload-button" onclick="document.getElementById('file3').click()">
                            –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </button>
                        <input type="file" id="file3" class="file-input" accept=".xlsx,.csv" onchange="handleFileUpload(3, this)">
                        <div class="file-status" id="file3-status">‚úì –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    </div>
                </div>

                <div class="file-upload-item" id="file4-area">
                    <div class="file-info">
                        <div class="file-title">–û—Ç–≥—É–ª—ã –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</div>
                        <div class="file-description">XLSX —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: User, Description, Time (h), Time (decimal), Amount (RUB) (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ CSV)</div>
                        <button class="file-upload-button" onclick="document.getElementById('file4').click()">
                            –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </button>
                        <input type="file" id="file4" class="file-input" accept=".xlsx,.csv" onchange="handleFileUpload(4, this)">
                        <div class="file-status" id="file4-status">‚úì –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
        <div class="section">
            <div class="section-title">2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á—ë—Ç–∞</div>
            <div class="parameters-grid">
                <div class="parameter-item">
                    <label class="parameter-label" for="year-select">–ì–æ–¥</label>
                    <select id="year-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                    </select>
                </div>

                <div class="parameter-item">
                    <label class="parameter-label" for="month-select">–ú–µ—Å—è—Ü</label>
                    <select id="month-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <option value="–Ø–Ω–≤–∞—Ä—å">–Ø–Ω–≤–∞—Ä—å</option>
                        <option value="–§–µ–≤—Ä–∞–ª—å">–§–µ–≤—Ä–∞–ª—å</option>
                        <option value="–ú–∞—Ä—Ç">–ú–∞—Ä—Ç</option>
                        <option value="–ê–ø—Ä–µ–ª—å">–ê–ø—Ä–µ–ª—å</option>
                        <option value="–ú–∞–π">–ú–∞–π</option>
                        <option value="–ò—é–Ω—å">–ò—é–Ω—å</option>
                        <option value="–ò—é–ª—å">–ò—é–ª—å</option>
                        <option value="–ê–≤–≥—É—Å—Ç">–ê–≤–≥—É—Å—Ç</option>
                        <option value="–°–µ–Ω—Ç—è–±—Ä—å">–°–µ–Ω—Ç—è–±—Ä—å</option>
                        <option value="–û–∫—Ç—è–±—Ä—å">–û–∫—Ç—è–±—Ä—å</option>
                        <option value="–ù–æ—è–±—Ä—å">–ù–æ—è–±—Ä—å</option>
                        <option value="–î–µ–∫–∞–±—Ä—å">–î–µ–∫–∞–±—Ä—å</option>
                    </select>
                </div>

                <div class="parameter-item">
                    <label class="parameter-label" for="work-days-select">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</label>
                    <select id="work-days-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                    </select>
                </div>

                <div class="parameter-item">
                    <label class="parameter-label" for="work-hours-select">–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –≤ –º–µ—Å—è—Ü</label>
                    <select id="work-hours-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div class="section">
            <div class="section-title">3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">–ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>

            <div class="error-details" id="error-details">
                <h4>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:</h4>
                <ul class="error-list" id="error-list"></ul>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="process-btn" onclick="processData()" disabled>
                üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
            <button class="btn btn-success" id="download-btn" onclick="downloadReport()" disabled style="display: none;">
                üì• –°–∫–∞—á–∞—Ç—å CSV –æ—Ç—á—ë—Ç
            </button>
        </div>
    </div>

    <!-- Footer –¥–ª—è –æ—à–∏–±–æ–∫ -->
    <div class="error-footer" id="error-footer">
        <div class="error-footer-header">
            <div class="error-footer-title">‚ö†Ô∏è –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏</div>
            <button class="error-footer-close" onclick="hideErrorFooter()">√ó</button>
        </div>
        <div class="error-footer-content" id="error-footer-content"></div>
        <div class="error-footer-actions">
            <button class="error-footer-btn" onclick="copyErrorToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="error-footer-btn" onclick="hideErrorFooter()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let pyodide = null;
        let uploadedFiles = {
            file1: null,
            file2: null,
            file3: null,
            file4: null
        };
        let processedData = null;
        let currentErrors = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeSelects();
            loadFromLocalStorage();
            initializePyodide();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
        function initializeSelects() {
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥–æ–¥–æ–≤
            const yearSelect = document.getElementById('year-select');
            for (let year = 2025; year <= 2050; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
            const workDaysSelect = document.getElementById('work-days-select');
            for (let days = 10; days <= 30; days++) {
                const option = document.createElement('option');
                option.value = days;
                option.textContent = days + ' –¥–Ω.';
                workDaysSelect.appendChild(option);
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤
            const workHoursSelect = document.getElementById('work-hours-select');
            for (let hours = 120; hours <= 200; hours++) {
                const option = document.createElement('option');
                option.value = hours;
                option.textContent = hours + ' —á.';
                workHoursSelect.appendChild(option);
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            yearSelect.value = '2025';
            document.getElementById('month-select').value = '–Ø–Ω–≤–∞—Ä—å';
            workDaysSelect.value = '22';
            workHoursSelect.value = '176';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pyodide
        async function initializePyodide() {
            showNotification('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Python...', 'warning');
            try {
                pyodide = await loadPyodide();
                console.log('Pyodide –∑–∞–≥—Ä—É–∂–µ–Ω');
                
                await pyodide.loadPackage(['pandas']);
                console.log('–ü–∞–∫–µ—Ç pandas –∑–∞–≥—Ä—É–∂–µ–Ω');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º openpyxl –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ XLSX
                try {
                    await pyodide.loadPackage(['openpyxl']);
                    console.log('–ü–∞–∫–µ—Ç openpyxl –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ XLSX');
                    window.xlsxConversionAvailable = true;
                } catch (e) {
                    console.log('openpyxl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è XLSX –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞');
                    window.xlsxConversionAvailable = false;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Python –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                await loadPythonCode();
                
                showNotification('Python –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Pyodide:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Python: ' + error.message, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ Python –∫–æ–¥–∞
        async function loadPythonCode() {
            try {
                const pythonCode = `
import pandas as pd
import io
import json
import re
import base64

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
transliteration_map = {
    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo',
    '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
    '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
    '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch',
    '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
}

reverse_transliteration_map = {v: k for k, v in transliteration_map.items() if v}

def normalize_name(name):
    """–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è"""
    if not isinstance(name, str):
        return ""
    
    # –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
    name = ' '.join(name.strip().split())
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–æ–≤
    name = re.sub(r'\\b([–ê-–ØA-Z])\\.', r'\\1', name)
    
    # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ Title Case
    name = name.title()
    
    return name

def transliterate_ru_to_en(text):
    """–¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π"""
    result = ""
    for char in text.lower():
        result += transliteration_map.get(char, char)
    return result.title()

def transliterate_en_to_ru(text):
    """–¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π"""
    text = text.lower()
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–Ω–æ–≥–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏
    for en, ru in [('sch', '—â'), ('sh', '—à'), ('ch', '—á'), ('zh', '–∂'), ('ts', '—Ü'), ('yo', '—ë'), ('yu', '—é'), ('ya', '—è')]:
        text = text.replace(en, ru)
    
    # –ó–∞—Ç–µ–º –æ–¥–Ω–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–µ
    result = ""
    for char in text:
        result += reverse_transliteration_map.get(char, char)
    return result.title()

def find_name_match(target_name, names_list):
    """–ü–æ–∏—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∏–º–µ–Ω–∏ –≤ —Å–ø–∏—Å–∫–µ"""
    target_normalized = normalize_name(target_name)
    matches = []
    
    for name in names_list:
        name_normalized = normalize_name(name)
        
        # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if target_normalized.lower() == name_normalized.lower():
            matches.append(name)
            continue
        
        # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π RU -> EN
        transliterated_ru_en = transliterate_ru_to_en(name_normalized)
        if target_normalized.lower() == transliterated_ru_en.lower():
            matches.append(name)
            continue
            
        # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π EN -> RU
        transliterated_en_ru = transliterate_en_to_ru(target_normalized)
        if transliterated_en_ru.lower() == name_normalized.lower():
            matches.append(name)
            continue
    
    if len(matches) == 1:
        return matches[0], None
    elif len(matches) == 0:
        return None, "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ '" + target_name + "' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ"
    else:
        return None, "–ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –¥–ª—è '" + target_name + "': " + ", ".join(matches)

def process_files(file1_content, file2_content, file3_content, file4_content, year, month, work_days, work_hours):
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤"""
    errors = []
    
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ 1 (CSV - —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)
        try:            
            df1 = pd.read_csv(io.StringIO(file1_content))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏
            name_column = None
            for col in df1.columns:
                if col.strip().lower() in ['–∏–º—è', 'name', '—Ñ–∏–æ']:
                    name_column = col
                    break
            
            if name_column is None:
                errors.append("–§–∞–π–ª 1: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å –∏–º–µ–Ω–∞–º–∏. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: " + str(list(df1.columns)))
                return None, errors
            
            # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
            if name_column != '–ò–º—è':
                df1 = df1.rename(columns={name_column: '–ò–º—è'})
            
            df1 = df1.dropna(subset=['–ò–º—è']).reset_index(drop=True)
            if df1.empty:
                errors.append("–§–∞–π–ª 1: –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏")
        except Exception as e:
            import traceback
            error_trace = traceback.format_exc()
            errors.append("–§–∞–π–ª 1: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV - " + str(e) + ". Traceback: " + error_trace)
            return None, errors
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ 2 (CSV - —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü)
        try:
            if file2_content:
                df2 = pd.read_csv(io.StringIO(file2_content))
                df2 = df2.dropna(subset=['–§–ò–û'] if '–§–ò–û' in df2.columns else df2.columns[:1]).reset_index(drop=True)
            else:
                df2 = pd.DataFrame()
                errors.append("–§–∞–π–ª 2: –§–∞–π–ª –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω")
        except Exception as e:
            errors.append("–§–∞–π–ª 2: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV - " + str(e))
            df2 = pd.DataFrame()
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ 3 (CSV - —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)
        try:
            if file3_content:
                df3 = pd.read_csv(io.StringIO(file3_content))
                df3 = df3.dropna(subset=['User'] if 'User' in df3.columns else df3.columns[:1]).reset_index(drop=True)
                if 'Time (decimal)' in df3.columns:
                    df3 = df3[['User', 'Time (decimal)']]
                else:
                    errors.append("–§–∞–π–ª 3: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ 'Time (decimal)'")
                    df3 = pd.DataFrame(columns=['User', 'Time (decimal)'])
            else:
                df3 = pd.DataFrame(columns=['User', 'Time (decimal)'])
                errors.append("–§–∞–π–ª 3: –§–∞–π–ª –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω")
        except Exception as e:
            errors.append("–§–∞–π–ª 3: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV - " + str(e))
            df3 = pd.DataFrame(columns=['User', 'Time (decimal)'])
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ 4 (CSV - –æ—Ç–≥—É–ª—ã)
        try:
            if file4_content:
                df4 = pd.read_csv(io.StringIO(file4_content))
                df4 = df4.dropna(subset=['User'] if 'User' in df4.columns else df4.columns[:1]).reset_index(drop=True)
                if 'Time (decimal)' in df4.columns:
                    df4 = df4[['User', 'Time (decimal)']]
                else:
                    errors.append("–§–∞–π–ª 4: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ 'Time (decimal)'")
                    df4 = pd.DataFrame(columns=['User', 'Time (decimal)'])
            else:
                df4 = pd.DataFrame(columns=['User', 'Time (decimal)'])
                errors.append("–§–∞–π–ª 4: –§–∞–π–ª –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω")
        except Exception as e:
            errors.append("–§–∞–π–ª 4: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV - " + str(e))
            df4 = pd.DataFrame(columns=['User', 'Time (decimal)'])
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ DataFrame
        result_df = df1.copy()
        result_df['–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π'] = work_days
        result_df['–û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü'] = 0.0
        result_df['–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤'] = 0.0
        result_df['–û—Ç–≥—É–ª—ã'] = 0.0
        result_df['–ò—Ç–æ–≥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü'] = 0.0
        result_df['N (—Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã –≤ –º–µ—Å—è—Ü)'] = work_hours
        result_df['–û—à–∏–±–∫–∏'] = ""
        
        print("–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É", len(result_df), "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        for idx, row in result_df.iterrows():
            employee_name = row['–ò–º—è']
            employee_errors = []
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
            previous_balance = 0  # –û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
            time_without_vacation = 0  # –í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤ (–∏–∑ —Ñ–∞–π–ª–∞ 3)
            vacation_time = 0  # –û—Ç–≥—É–ª—ã (–∏–∑ —Ñ–∞–π–ª–∞ 4)
            
            # –ü–æ–∏—Å–∫ –≤ —Ñ–∞–π–ª–µ 2 (–æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü)
            if not df2.empty and '–§–ò–û' in df2.columns:
                match_name, error = find_name_match(employee_name, df2['–§–ò–û'].tolist())
                if match_name:
                    match_row = df2[df2['–§–ò–û'] == match_name]
                    if len(match_row) == 1:
                        if '–û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü' in df2.columns:
                            val = match_row.iloc[0]['–û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü']
                            if pd.notna(val) and val != '':
                                try:
                                    previous_balance = float(val)
                                    result_df.at[idx, '–û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü'] = previous_balance
                                except ValueError:
                                    employee_errors.append("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞")
                    elif len(match_row) > 1:
                        employee_errors.append("–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª–µ 2")
            
            # –ü–æ–∏—Å–∫ –≤ —Ñ–∞–π–ª–µ 3 (–≤—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤)
            if not df3.empty and 'User' in df3.columns:
                match_name, error = find_name_match(employee_name, df3['User'].tolist())
                if match_name:
                    match_rows = df3[df3['User'] == match_name]
                    if len(match_rows) >= 1:
                        # –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —á–∞—Å—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        total_time = 0
                        for _, match_row in match_rows.iterrows():
                            if 'Time (decimal)' in df3.columns:
                                time_value = match_row['Time (decimal)']
                                if pd.notna(time_value) and time_value != '':
                                    try:
                                        total_time += float(time_value)
                                    except (ValueError, TypeError):
                                        pass
                        time_without_vacation = total_time
                        result_df.at[idx, '–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤'] = time_without_vacation
            
            # –ü–æ–∏—Å–∫ –≤ —Ñ–∞–π–ª–µ 4 (–æ—Ç–≥—É–ª—ã)
            if not df4.empty and 'User' in df4.columns:
                match_name, error = find_name_match(employee_name, df4['User'].tolist())
                if match_name:
                    match_rows = df4[df4['User'] == match_name]
                    if len(match_rows) >= 1:
                        # –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —á–∞—Å—ã –æ—Ç–≥—É–ª–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        total_vacation = 0
                        for _, match_row in match_rows.iterrows():
                            if 'Time (decimal)' in df4.columns:
                                vacation_value = match_row['Time (decimal)']
                                if pd.notna(vacation_value) and vacation_value != '':
                                    try:
                                        total_vacation += float(vacation_value)
                                    except (ValueError, TypeError):
                                        pass
                        vacation_time = total_vacation
                        result_df.at[idx, '–û—Ç–≥—É–ª—ã'] = vacation_time
            
            # –†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: N - –í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤ - –û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü + –û—Ç–≥—É–ª—ã
            try:
                remainder = result_df.at[idx, '–û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü'] or 0
                time_worked = result_df.at[idx, '–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤'] or 0
                time_off = result_df.at[idx, '–û—Ç–≥—É–ª—ã'] or 0
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞
                remainder = float(remainder) if pd.notna(remainder) else 0
                time_worked = float(time_worked) if pd.notna(time_worked) else 0
                time_off = float(time_off) if pd.notna(time_off) else 0
                
                total = work_hours - time_worked - remainder + time_off
                result_df.at[idx, '–ò—Ç–æ–≥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü'] = total
            except Exception as e:
                employee_errors.append("–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –∏—Ç–æ–≥–∞: " + str(e))
            
            # –ó–∞–ø–∏—Å—å –æ—à–∏–±–æ–∫ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if employee_errors:
                result_df.at[idx, '–û—à–∏–±–∫–∏'] = "; ".join(employee_errors)
        
        return result_df, errors
        
    except Exception as e:
        errors.append("–û–±—â–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: " + str(e))
        return None, errors

def create_csv_report(df, filename):
    """–°–æ–∑–¥–∞–Ω–∏–µ CSV –æ—Ç—á—ë—Ç–∞"""
    try:
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
        headers = ['–§–ò–û', '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π', 
                  '–û—Å—Ç–∞—Ç–æ–∫ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü', '–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≥—É–ª–æ–≤', 
                  '–û—Ç–≥—É–ª—ã', '–ò—Ç–æ–≥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü', 'N (—Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã –≤ –º–µ—Å—è—Ü)', '–û—à–∏–±–∫–∏']
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º DataFrame –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        df_export = df.copy()
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –∏–º–µ–Ω–∞–º–∏
        if '–ò–º—è' in df_export.columns:
            df_export = df_export.rename(columns={'–ò–º—è': '–§–ò–û'})
        
        # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å
        for header in headers:
            if header not in df_export.columns:
                df_export[header] = ""
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        df_export = df_export[headers]
        
        # –°–æ–∑–¥–∞—ë–º CSV —Ñ–∞–π–ª —Å —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º –¥–ª—è Excel
        csv_output = io.StringIO()
        df_export.to_csv(csv_output, index=False, sep=';', encoding='utf-8')
        csv_content = csv_output.getvalue()
        
        return csv_content
        
    except Exception as e:
        raise Exception("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CSV —Ñ–∞–π–ª–∞: " + str(e))
`;
            
                await pyodide.runPython(pythonCode);
                console.log('Python –∫–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
                const testResult = await pyodide.runPython(`
callable(process_files) and callable(create_csv_report)
                `);
                
                if (!testResult) {
                    throw new Error('Python —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Python –∫–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Python –∫–æ–¥–∞: ' + error.message, 'error');
                throw error;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        async function handleFileUpload(fileNumber, input) {
            const file = input.files[0];
            if (!file) return;

            const area = document.getElementById(`file${fileNumber}-area`);
            const status = document.getElementById(`file${fileNumber}-status`);
            
            try {
                showNotification(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª ${fileNumber}...`, 'warning');
                
                if (file.name.endsWith('.csv') || fileNumber === 1) {
                    // CSV —Ñ–∞–π–ª—ã —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedFiles[`file${fileNumber}`] = e.target.result;
                        
                        area.classList.add('uploaded');
                        status.style.display = 'block';
                        
                        showNotification(`–§–∞–π–ª ${fileNumber} –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                        checkReadyToProcess();
                    };
                    reader.readAsText(file);
                } else if (file.name.endsWith('.xlsx')) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ XLSX
                    if (!window.xlsxConversionAvailable) {
                        throw new Error('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –≤ CSV –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.');
                    }
                    
                    // XLSX —Ñ–∞–π–ª—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ CSV
                    showNotification(`–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º XLSX —Ñ–∞–π–ª ${fileNumber} –≤ CSV...`, 'warning');
                    
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    const csvContent = await convertXlsxToCsv(arrayBuffer, fileNumber);
                    
                    uploadedFiles[`file${fileNumber}`] = csvContent;
                    
                    area.classList.add('uploaded');
                    status.style.display = 'block';
                    
                    showNotification(`–§–∞–π–ª ${fileNumber} —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
                    checkReadyToProcess();
                } else {
                    throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .xlsx –∏–ª–∏ .csv');
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${fileNumber}:`, error);
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${fileNumber}: ${error.message}`, 'error');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∫–∞–∫ ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è XLSX –≤ CSV —Å –ø–æ–º–æ—â—å—é Python
        async function convertXlsxToCsv(arrayBuffer, fileNumber) {
            if (!pyodide) {
                throw new Error('Python –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }

            try {
                // –ü–µ—Ä–µ–¥–∞—ë–º ArrayBuffer –≤ Python
                const uint8Array = new Uint8Array(arrayBuffer);
                pyodide.globals.set('xlsx_data', uint8Array);
                pyodide.globals.set('file_number', fileNumber);

                const csvContent = await pyodide.runPython(`
import pandas as pd
import io

try:
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Uint8Array –≤ bytes
    xlsx_bytes = bytes(xlsx_data.to_py())
    
    # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
    df = pd.read_excel(io.BytesIO(xlsx_bytes))
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –¥–ª—è —Ñ–∞–π–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
    if file_number == 3 or file_number == 4:
        # –î–ª—è —Ñ–∞–π–ª–æ–≤ 3 –∏ 4 - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        df = df.dropna(subset=['User'] if 'User' in df.columns else df.columns[:1])
        if 'Time (decimal)' in df.columns and 'User' in df.columns:
            df = df[['User', 'Time (decimal)']]
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ CSV
    csv_output = io.StringIO()
    df.to_csv(csv_output, index=False)
    csv_content = csv_output.getvalue()
    csv_content
    
except Exception as e:
    f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ XLSX –≤ CSV: {str(e)}"
                `);

                if (csvContent.startsWith('–û—à–∏–±–∫–∞')) {
                    throw new Error(csvContent);
                }

                return csvContent;
                
            } catch (error) {
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å XLSX —Ñ–∞–π–ª: ${error.message}`);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ
        function checkReadyToProcess() {
            const allFilesUploaded = Object.values(uploadedFiles).every(file => file !== null);
            const processBtn = document.getElementById('process-btn');
            
            if (allFilesUploaded) {
                processBtn.disabled = false;
                updateProgress(20, '–í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ.');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function processData() {
            if (!pyodide) {
                showNotification('Python –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }

            const loadingElement = document.getElementById('loading');
            const processBtn = document.getElementById('process-btn');
            const downloadBtn = document.getElementById('download-btn');
            const errorDetails = document.getElementById('error-details');
            
            try {
                loadingElement.style.display = 'block';
                processBtn.disabled = true;
                downloadBtn.style.display = 'none';
                errorDetails.style.display = 'none';
                
                updateProgress(30, '–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö...');
                console.log('–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                const fileStatus = {
                    file1: uploadedFiles.file1 ? '–∑–∞–≥—Ä—É–∂–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                    file2: uploadedFiles.file2 ? '–∑–∞–≥—Ä—É–∂–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 
                    file3: uploadedFiles.file3 ? '–∑–∞–≥—Ä—É–∂–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                    file4: uploadedFiles.file4 ? '–∑–∞–≥—Ä—É–∂–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
                };
                console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:', fileStatus);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                const missingFiles = [];
                if (!uploadedFiles.file1) missingFiles.push('–§–∞–π–ª 1 (–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)');
                if (!uploadedFiles.file2) missingFiles.push('–§–∞–π–ª 2 (–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü)');
                if (!uploadedFiles.file3) missingFiles.push('–§–∞–π–ª 3 (–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)');
                if (!uploadedFiles.file4) missingFiles.push('–§–∞–π–ª 4 (–û—Ç–≥—É–ª—ã –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü)');

                if (missingFiles.length > 0) {
                    throw new Error('–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã:\\n' + missingFiles.join('\\n'));
                }

                // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                const year = document.getElementById('year-select').value;
                const month = document.getElementById('month-select').value;
                const workDays = parseInt(document.getElementById('work-days-select').value);
                const workHours = parseInt(document.getElementById('work-hours-select').value);

                console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', { year, month, workDays, workHours });

                updateProgress(40, '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ Python...');

                // –ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤ –≤ Python (–≤—Å–µ –∫–∞–∫ —Ç–µ–∫—Å—Ç)
                pyodide.globals.set('file1_content', uploadedFiles.file1);
                pyodide.globals.set('file2_content', uploadedFiles.file2);
                pyodide.globals.set('file3_content', uploadedFiles.file3);
                pyodide.globals.set('file4_content', uploadedFiles.file4);

                updateProgress(60, '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');

                // –í—ã–∑–æ–≤ Python —Ñ—É–Ω–∫—Ü–∏–∏
                console.log('–í—ã–∑—ã–≤–∞–µ–º Python —Ñ—É–Ω–∫—Ü–∏—é process_files');
                const result = await pyodide.runPython(`
try:
    print("–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–æ–≤ –≤ Python")
    print("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –≥–æ–¥=" + str(${year}) + ", –º–µ—Å—è—Ü=${month}, –¥–Ω–∏=" + str(${workDays}) + ", —á–∞—Å—ã=" + str(${workHours}))
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥–∞–Ω—ã (–≤—Å–µ –∫–∞–∫ —Ç–µ–∫—Å—Ç CSV)
    print("file1_content —Ç–∏–ø:", type(file1_content), ", –¥–ª–∏–Ω–∞:", len(file1_content) if file1_content else 0)
    print("file2_content —Ç–∏–ø:", type(file2_content), ", –¥–ª–∏–Ω–∞:", len(file2_content) if file2_content else 0)
    print("file3_content —Ç–∏–ø:", type(file3_content), ", –¥–ª–∏–Ω–∞:", len(file3_content) if file3_content else 0)
    print("file4_content —Ç–∏–ø:", type(file4_content), ", –¥–ª–∏–Ω–∞:", len(file4_content) if file4_content else 0)
    
    result_df, errors = process_files(file1_content, file2_content, file3_content, file4_content, ${year}, "${month}", ${workDays}, ${workHours})
    
    print("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. DataFrame:", result_df is not None, ", –û—à–∏–±–∫–∏:", len(errors) if errors else 0)
    
    result = (result_df.to_json(orient='records') if result_df is not None else None, errors)
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ JavaScript")
    
except Exception as e:
    import traceback
    error_trace = traceback.format_exc()
    print("Error in process_files:", str(e))
    print("Traceback:", error_trace)
    result = (None, ["–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: " + str(e) + ". Traceback: " + error_trace])
result
                `);
                
                console.log('Python —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω');

                console.log('–¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ Python:', typeof result);
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç Python:', result);

                let dataJson, errors;
                try {
                    if (result && typeof result.toJs === 'function') {
                        [dataJson, errors] = result.toJs();
                    } else {
                        // –ï—Å–ª–∏ result –Ω–µ —è–≤–ª—è–µ—Ç—Å—è Pyodide –æ–±—ä–µ–∫—Ç–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é
                        if (Array.isArray(result) && result.length === 2) {
                            [dataJson, errors] = result;
                        } else {
                            console.error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', result);
                            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç Python —Ñ—É–Ω–∫—Ü–∏–∏');
                        }
                    }
                    
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á—ë–Ω –∏–∑ Python:', {
                        dataJson: dataJson ? '–ø–æ–ª—É—á–µ–Ω' : '–ø—É—Å—Ç–æ–π',
                        dataJsonType: typeof dataJson,
                        errorsCount: errors ? errors.length : 0,
                        errorsType: typeof errors
                    });
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', e);
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ Python: ' + e.message);
                }
                
                updateProgress(80, '–§–æ—Ä–º–∏—Ä—É–µ–º CSV –æ—Ç—á—ë—Ç...');

                if (dataJson && dataJson !== 'None' && dataJson !== null) {
                    processedData = JSON.parse(dataJson);
                    
                    // –°–æ–∑–¥–∞–Ω–∏–µ CSV —Ñ–∞–π–ª–∞
                    const filename = `–û—Ç—á–µ—Ç –ø–æ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç–∞–º ${month}_${year}.csv`;
                    
                    // –ü–µ—Ä–µ–¥–∞—ë–º DataFrame –æ–±—Ä–∞—Ç–Ω–æ –≤ Python –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è CSV
                    pyodide.globals.set('data_json', dataJson);
                    pyodide.globals.set('report_filename', filename);
                    
                    await pyodide.runPython(`
try:
    import pandas as pd
    import json
    data = json.loads(data_json)
    df_for_csv = pd.DataFrame(data)
    csv_content = create_csv_report(df_for_csv, report_filename)
    print("CSV report created successfully, length:", len(csv_content))
except Exception as e:
    import traceback
    print("Error creating CSV:", str(e))
    print("Traceback:", traceback.format_exc())
    csv_content = None
                    `);
                    
                    const csvData = pyodide.globals.get('csv_content');
                    
                    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    window.reportData = {
                        data: csvData,
                        filename: filename
                    };
                    
                    updateProgress(100, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                    
                    downloadBtn.style.display = 'inline-flex';
                    downloadBtn.disabled = false;
                    
                    showNotification('–î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    console.error('dataJson –ø—É—Å—Ç–æ–π –∏–ª–∏ null:', {
                        dataJson: dataJson,
                        errors: errors,
                        rawResult: result
                    });
                    
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ';
                    if (errors && errors.length > 0) {
                        errorMessage += ':\n' + errors.join('\n');
                    } else {
                        errorMessage += '. Python —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
                    }
                    
                    throw new Error(errorMessage);
                }

                // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (errors && errors.length > 0) {
                    currentErrors = errors;
                    displayErrors(errors);
                    showNotification(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å ${errors.length} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏`, 'warning');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É
                let detailedError = error.message;
                if (error.stack) {
                    detailedError += '\n\nStack trace:\n' + error.stack;
                }
                
                showNotification('–ü–æ–¥—Ä–æ–±–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö:\n\n' + detailedError, 'error');
                updateProgress(0, '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ —Å–µ–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫
                if (currentErrors.length === 0) {
                    currentErrors.push(detailedError);
                }
                displayErrors(currentErrors);
                
            } finally {
                loadingElement.style.display = 'none';
                processBtn.disabled = false;
            }
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
        function downloadReport() {
            if (!window.reportData) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'error');
                return;
            }

            try {
                // –î–æ–±–∞–≤–ª—è–µ–º BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Excel
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + window.reportData.data;
                
                // –°–æ–∑–¥–∞–Ω–∏–µ Blob –∏–∑ CSV —Å—Ç—Ä–æ–∫–∏
                const blob = new Blob([csvWithBOM], {
                    type: 'text/csv;charset=utf-8'
                });

                // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.reportData.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('CSV —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫
        function displayErrors(errors) {
            const errorDetails = document.getElementById('error-details');
            const errorList = document.getElementById('error-list');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorDetails.style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Error Footer
        function showErrorFooter(errorMessage) {
            const footer = document.getElementById('error-footer');
            const content = document.getElementById('error-footer-content');
            
            content.textContent = errorMessage;
            footer.classList.add('show');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—à–∏–±–∫—É –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            window.lastError = errorMessage;
        }

        function hideErrorFooter() {
            const footer = document.getElementById('error-footer');
            footer.classList.remove('show');
        }

        function copyErrorToClipboard() {
            if (window.lastError) {
                navigator.clipboard.writeText(window.lastError).then(() => {
                    showNotification('–û—à–∏–±–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                }).catch(() => {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = window.lastError;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('–û—à–∏–±–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                });
            }
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingNotifications = document.querySelectorAll('.notification.show');
            let topPosition = 20;
            existingNotifications.forEach(existing => {
                topPosition += existing.offsetHeight + 10;
            });
            notification.style.top = topPosition + 'px';
            
            // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
            const content = document.createElement('div');
            content.className = 'notification-content';
            content.style.whiteSpace = 'pre-wrap'; // –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
            content.textContent = message;
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.alignItems = 'center';
            
            // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—à–∏–±–æ–∫)
            if (type === 'error') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'notification-copy';
                copyBtn.innerHTML = 'üìã';
                copyBtn.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É';
                                        copyBtn.onclick = () => {
                    navigator.clipboard.writeText(message).then(() => {
                        copyBtn.innerHTML = '‚úì';
                        setTimeout(() => {
                            copyBtn.innerHTML = 'üìã';
                        }, 1000);
                    });
                };
                
                // –î–ª—è –æ—à–∏–±–æ–∫ —Ç–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º footer
                copyBtn.ondblclick = () => {
                    showErrorFooter(message);
                };
                buttonsContainer.appendChild(copyBtn);
            }
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'notification-close';
            closeBtn.innerHTML = '√ó';
            closeBtn.onclick = () => closeNotification(notification);
            buttonsContainer.appendChild(closeBtn);
            
            notification.appendChild(content);
            notification.appendChild(buttonsContainer);
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // –î–ª—è –æ—à–∏–±–æ–∫ - –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            if (type !== 'error') {
                setTimeout(() => {
                    closeNotification(notification);
                }, 5000); // –£–≤–µ–ª–∏—á–∏–ª –≤—Ä–µ–º—è –¥–æ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
            } else {
                // –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º footer
                if (message.length > 200) {
                    setTimeout(() => {
                        showErrorFooter(message);
                    }, 500); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º footer —á–µ—Ä–µ–∑ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ—à–∏–±–æ–∫
                }
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function closeNotification(notification) {
            if (notification && notification.parentNode) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ LocalStorage
        function saveToLocalStorage() {
            const params = {
                year: document.getElementById('year-select').value,
                month: document.getElementById('month-select').value,
                workDays: document.getElementById('work-days-select').value,
                workHours: document.getElementById('work-hours-select').value,
                timestamp: Date.now()
            };
            
            localStorage.setItem('workAnalysisParams', JSON.stringify(params));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ LocalStorage
        function loadFromLocalStorage() {
            const stored = localStorage.getItem('workAnalysisParams');
            if (!stored) return;
            
            try {
                const params = JSON.parse(stored);
                const twoHours = 2 * 60 * 60 * 1000; // 2 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
                if (Date.now() - params.timestamp > twoHours) {
                    localStorage.removeItem('workAnalysisParams');
                    return;
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                document.getElementById('year-select').value = params.year;
                document.getElementById('month-select').value = params.month;
                document.getElementById('work-days-select').value = params.workDays;
                document.getElementById('work-hours-select').value = params.workHours;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ LocalStorage:', error);
                localStorage.removeItem('workAnalysisParams');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ LocalStorage –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            // LocalStorage –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–∑–∏—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤
        });
    </script>
</body>
</html>
