<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ трудозатрат</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-color: #e8f4f8;
            --secondary-color: #f5f1ff;
            --accent-color: #a7c7e7;
            --text-color: #4a5568;
            --border-color: #e2e8f0;
            --success-color: #68d391;
            --error-color: #fc8181;
            --warning-color: #fbb86f;
            --button-hover: #9fb9d4;
            --background: #fafcff;
            --card-bg: #ffffff;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 30px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            font-weight: 300;
            color: #718096;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .file-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-upload-item {
            background: var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .file-upload-item:hover {
            border-color: var(--accent-color);
            background: rgba(167, 199, 231, 0.1);
        }

        .file-upload-item.uploaded {
            border-color: var(--success-color);
            background: rgba(104, 211, 145, 0.1);
        }

        .file-upload-item .file-info {
            text-align: center;
        }

        .file-upload-item .file-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .file-upload-item .file-description {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 15px;
        }

        .file-upload-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .file-upload-button:hover {
            background: var(--button-hover);
        }

        .file-upload-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .file-input {
            display: none;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .parameter-label {
            font-weight: 500;
            color: var(--text-color);
        }

        .parameter-select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .parameter-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .progress-section {
            margin: 40px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #718096;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--button-hover);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #48bb78;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px 15px 15px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            padding: 0;
            margin: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .notification-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .notification-copy {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            margin-right: 5px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .notification-copy:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-status {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--success-color);
            display: none;
        }

        .error-details {
            margin-top: 20px;
            padding: 15px;
            background: rgba(252, 129, 129, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--error-color);
            display: none;
        }

        .error-details h4 {
            color: var(--error-color);
            margin-bottom: 10px;
        }

        .error-list {
            list-style: none;
            color: #742a2a;
        }

        .error-list li {
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .error-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--error-color);
        }

        .error-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(252, 129, 129, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--error-color);
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            display: none;
            z-index: 2000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .error-footer.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .error-footer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }

        .error-footer-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .error-footer-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .error-footer-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .error-footer-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            color: #742a2a;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 25vh;
            overflow-y: auto;
        }

        .error-footer-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .error-footer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .error-footer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px 15px 80px 15px; /* Добавляем отступ снизу для footer */
            }

            .header h1 {
                font-size: 2rem;
            }

            .file-upload-grid {
                grid-template-columns: 1fr;
            }

            .parameters-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .error-footer {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Анализ трудозатрат</h1>
            <p>Загрузите файлы и настройте параметры для формирования отчёта</p>
        </div>

        <!-- Загрузка файлов -->
        <div class="section">
            <div class="section-title">1. Загрузка файлов</div>
            <div class="file-upload-grid">
                <div class="file-upload-item" id="file1-area">
                    <div class="file-info">
                        <div class="file-title">Список сотрудников</div>
                        <div class="file-description">CSV файл с колонками: Имя, Должность</div>
                        <button class="file-upload-button" onclick="document.getElementById('file1').click()">
                            Выбрать файл
                        </button>
                        <input type="file" id="file1" class="file-input" accept=".csv" onchange="handleFileUpload(1, this)">
                        <div class="file-status" id="file1-status">✓ Файл загружен</div>
                    </div>
                </div>

                <div class="file-upload-item" id="file2-area">
                    <div class="file-info">
                        <div class="file-title">Трудозатраты прошлый месяц</div>
                        <div class="file-description">XLSX файл с колонками: ФИО, Кол-во рабочих дней, Остаток за позапрошлый месяц, Время без отгулов, Отгулы, Итог за текущий месяц, Должность (автоматически конвертируется в CSV)</div>
                        <button class="file-upload-button" onclick="document.getElementById('file2').click()">
                            Выбрать файл
                        </button>
                        <input type="file" id="file2" class="file-input" accept=".xlsx,.csv" onchange="handleFileUpload(2, this)">
                        <div class="file-status" id="file2-status">✓ Файл загружен</div>
                    </div>
                </div>

                <div class="file-upload-item" id="file3-area">
                    <div class="file-info">
                        <div class="file-title">Трудозатраты текущий месяц</div>
                        <div class="file-description">XLSX файл с колонками: User, Description, Time (h), Time (decimal), Amount (RUB) (автоматически конвертируется в CSV)</div>
                        <button class="file-upload-button" onclick="document.getElementById('file3').click()">
                            Выбрать файл
                        </button>
                        <input type="file" id="file3" class="file-input" accept=".xlsx,.csv" onchange="handleFileUpload(3, this)">
                        <div class="file-status" id="file3-status">✓ Файл загружен</div>
                    </div>
                </div>

                <div class="file-upload-item" id="file4-area">
                    <div class="file-info">
                        <div class="file-title">Отгулы прошлый месяц</div>
                        <div class="file-description">XLSX файл с колонками: User, Description, Time (h), Time (decimal), Amount (RUB) (автоматически конвертируется в CSV)</div>
                        <button class="file-upload-button" onclick="document.getElementById('file4').click()">
                            Выбрать файл
                        </button>
                        <input type="file" id="file4" class="file-input" accept=".xlsx,.csv" onchange="handleFileUpload(4, this)">
                        <div class="file-status" id="file4-status">✓ Файл загружен</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Параметры -->
        <div class="section">
            <div class="section-title">2. Параметры отчёта</div>
            <div class="parameters-grid">
                <div class="parameter-item">
                    <label class="parameter-label" for="year-select">Год</label>
                    <select id="year-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <!-- Заполняется JavaScript -->
                    </select>
                </div>

                <div class="parameter-item">
                    <label class="parameter-label" for="month-select">Месяц</label>
                    <select id="month-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <option value="Январь">Январь</option>
                        <option value="Февраль">Февраль</option>
                        <option value="Март">Март</option>
                        <option value="Апрель">Апрель</option>
                        <option value="Май">Май</option>
                        <option value="Июнь">Июнь</option>
                        <option value="Июль">Июль</option>
                        <option value="Август">Август</option>
                        <option value="Сентябрь">Сентябрь</option>
                        <option value="Октябрь">Октябрь</option>
                        <option value="Ноябрь">Ноябрь</option>
                        <option value="Декабрь">Декабрь</option>
                    </select>
                </div>

                <div class="parameter-item">
                    <label class="parameter-label" for="work-days-select">Количество рабочих дней</label>
                    <select id="work-days-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <!-- Заполняется JavaScript -->
                    </select>
                </div>

                <div class="parameter-item">
                    <label class="parameter-label" for="work-hours-select">Рабочих часов в месяц</label>
                    <select id="work-hours-select" class="parameter-select" onchange="saveToLocalStorage()">
                        <!-- Заполняется JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Прогресс -->
        <div class="section">
            <div class="section-title">3. Обработка данных</div>
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Готов к обработке</div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Обработка данных...</div>
            </div>

            <div class="error-details" id="error-details">
                <h4>Обнаружены ошибки:</h4>
                <ul class="error-list" id="error-list"></ul>
            </div>
        </div>

        <!-- Действия -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="process-btn" onclick="processData()" disabled>
                🔄 Обработать данные
            </button>
            <button class="btn btn-success" id="download-btn" onclick="downloadReport()" disabled style="display: none;">
                📥 Скачать CSV отчёт
            </button>
        </div>
    </div>

    <!-- Footer для ошибок -->
    <div class="error-footer" id="error-footer">
        <div class="error-footer-header">
            <div class="error-footer-title">⚠️ Подробности ошибки</div>
            <button class="error-footer-close" onclick="hideErrorFooter()">×</button>
        </div>
        <div class="error-footer-content" id="error-footer-content"></div>
        <div class="error-footer-actions">
            <button class="error-footer-btn" onclick="copyErrorToClipboard()">📋 Копировать</button>
            <button class="error-footer-btn" onclick="hideErrorFooter()">Закрыть</button>
        </div>
    </div>

    <!-- Подключение Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <script>
        // Глобальные переменные
        let pyodide = null;
        let uploadedFiles = {
            file1: null,
            file2: null,
            file3: null,
            file4: null
        };
        let processedData = null;
        let currentErrors = [];

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeSelects();
            loadFromLocalStorage();
            initializePyodide();
        });

        // Инициализация выпадающих списков
        function initializeSelects() {
            // Заполнение списка годов
            const yearSelect = document.getElementById('year-select');
            for (let year = 2025; year <= 2050; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // Заполнение списка рабочих дней
            const workDaysSelect = document.getElementById('work-days-select');
            for (let days = 10; days <= 30; days++) {
                const option = document.createElement('option');
                option.value = days;
                option.textContent = days + ' дн.';
                workDaysSelect.appendChild(option);
            }

            // Заполнение списка рабочих часов
            const workHoursSelect = document.getElementById('work-hours-select');
            for (let hours = 120; hours <= 200; hours++) {
                const option = document.createElement('option');
                option.value = hours;
                option.textContent = hours + ' ч.';
                workHoursSelect.appendChild(option);
            }

            // Установка значений по умолчанию
            yearSelect.value = '2025';
            document.getElementById('month-select').value = 'Январь';
            workDaysSelect.value = '22';
            workHoursSelect.value = '176';
        }

        // Инициализация Pyodide
        async function initializePyodide() {
            showNotification('Инициализация Python...', 'warning');
            try {
                pyodide = await loadPyodide();
                console.log('Pyodide загружен');
                
                await pyodide.loadPackage(['pandas']);
                console.log('Пакет pandas загружен');
                
                // Загружаем openpyxl для конвертации XLSX
                try {
                    await pyodide.loadPackage(['openpyxl']);
                    console.log('Пакет openpyxl загружен для конвертации XLSX');
                    window.xlsxConversionAvailable = true;
                } catch (e) {
                    console.log('openpyxl недоступен, конвертация XLSX будет ограничена');
                    window.xlsxConversionAvailable = false;
                }
                
                // Загружаем Python код для обработки данных
                await loadPythonCode();
                
                showNotification('Python готов к работе', 'success');
            } catch (error) {
                console.error('Ошибка инициализации Pyodide:', error);
                showNotification('Ошибка инициализации Python: ' + error.message, 'error');
            }
        }

        // Загрузка Python кода
        async function loadPythonCode() {
            try {
                const pythonCode = `
import pandas as pd
import io
import json
import re
import base64

# Словарь для транслитерации
transliteration_map = {
    'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo',
    'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
    'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
    'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
    'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
}

reverse_transliteration_map = {v: k for k, v in transliteration_map.items() if v}

def normalize_name(name):
    """Нормализация имени для сопоставления"""
    if not isinstance(name, str):
        return ""
    
    # Удаление лишних пробелов
    name = ' '.join(name.strip().split())
    
    # Удаление точек после инициалов
    name = re.sub(r'\\b([А-ЯA-Z])\\.', r'\\1', name)
    
    # Приведение к Title Case
    name = name.title()
    
    return name

def transliterate_ru_to_en(text):
    """Транслитерация с русского на английский"""
    result = ""
    for char in text.lower():
        result += transliteration_map.get(char, char)
    return result.title()

def transliterate_en_to_ru(text):
    """Транслитерация с английского на русский"""
    text = text.lower()
    # Обрабатываем многосимвольные сочетания первыми
    for en, ru in [('sch', 'щ'), ('sh', 'ш'), ('ch', 'ч'), ('zh', 'ж'), ('ts', 'ц'), ('yo', 'ё'), ('yu', 'ю'), ('ya', 'я')]:
        text = text.replace(en, ru)
    
    # Затем односимвольные
    result = ""
    for char in text:
        result += reverse_transliteration_map.get(char, char)
    return result.title()

def find_name_match(target_name, names_list):
    """Поиск соответствующего имени в списке"""
    target_normalized = normalize_name(target_name)
    matches = []
    
    for name in names_list:
        name_normalized = normalize_name(name)
        
        # Точное совпадение
        if target_normalized.lower() == name_normalized.lower():
            matches.append(name)
            continue
        
        # Совпадение с транслитерацией RU -> EN
        transliterated_ru_en = transliterate_ru_to_en(name_normalized)
        if target_normalized.lower() == transliterated_ru_en.lower():
            matches.append(name)
            continue
            
        # Совпадение с транслитерацией EN -> RU
        transliterated_en_ru = transliterate_en_to_ru(target_normalized)
        if transliterated_en_ru.lower() == name_normalized.lower():
            matches.append(name)
            continue
    
    if len(matches) == 1:
        return matches[0], None
    elif len(matches) == 0:
        return None, "Сотрудник '" + target_name + "' не найден в списке"
    else:
        return None, "Найдено несколько совпадений для '" + target_name + "': " + ", ".join(matches)

def process_files(file1_content, file2_content, file3_content, file4_content, year, month, work_days, work_hours):
    """Основная функция обработки файлов"""
    errors = []
    
    try:
        # Загрузка файла 1 (CSV - список сотрудников)
        try:            
            df1 = pd.read_csv(io.StringIO(file1_content))
            
            # Проверяем разные варианты названия колонки
            name_column = None
            for col in df1.columns:
                if col.strip().lower() in ['имя', 'name', 'фио']:
                    name_column = col
                    break
            
            if name_column is None:
                errors.append("Файл 1: Не найдена колонка с именами. Доступные колонки: " + str(list(df1.columns)))
                return None, errors
            
            # Переименовываем колонку для единообразия
            if name_column != 'Имя':
                df1 = df1.rename(columns={name_column: 'Имя'})
            
            df1 = df1.dropna(subset=['Имя']).reset_index(drop=True)
            if df1.empty:
                errors.append("Файл 1: Не найдено сотрудников с именами")
        except Exception as e:
            import traceback
            error_trace = traceback.format_exc()
            errors.append("Файл 1: Ошибка чтения CSV - " + str(e) + ". Traceback: " + error_trace)
            return None, errors
        
        # Загрузка файла 2 (CSV - трудозатраты прошлый месяц)
        try:
            if file2_content:
                df2 = pd.read_csv(io.StringIO(file2_content))
                df2 = df2.dropna(subset=['ФИО'] if 'ФИО' in df2.columns else df2.columns[:1]).reset_index(drop=True)
            else:
                df2 = pd.DataFrame()
                errors.append("Файл 2: Файл не передан")
        except Exception as e:
            errors.append("Файл 2: Ошибка чтения CSV - " + str(e))
            df2 = pd.DataFrame()
        
        # Загрузка и очистка файла 3 (CSV - трудозатраты текущий месяц)
        try:
            if file3_content:
                df3 = pd.read_csv(io.StringIO(file3_content))
                df3 = df3.dropna(subset=['User'] if 'User' in df3.columns else df3.columns[:1]).reset_index(drop=True)
                if 'Time (decimal)' in df3.columns:
                    df3 = df3[['User', 'Time (decimal)']]
                else:
                    errors.append("Файл 3: Не найдена колонка 'Time (decimal)'")
                    df3 = pd.DataFrame(columns=['User', 'Time (decimal)'])
            else:
                df3 = pd.DataFrame(columns=['User', 'Time (decimal)'])
                errors.append("Файл 3: Файл не передан")
        except Exception as e:
            errors.append("Файл 3: Ошибка чтения CSV - " + str(e))
            df3 = pd.DataFrame(columns=['User', 'Time (decimal)'])
        
        # Загрузка и очистка файла 4 (CSV - отгулы)
        try:
            if file4_content:
                df4 = pd.read_csv(io.StringIO(file4_content))
                df4 = df4.dropna(subset=['User'] if 'User' in df4.columns else df4.columns[:1]).reset_index(drop=True)
                if 'Time (decimal)' in df4.columns:
                    df4 = df4[['User', 'Time (decimal)']]
                else:
                    errors.append("Файл 4: Не найдена колонка 'Time (decimal)'")
                    df4 = pd.DataFrame(columns=['User', 'Time (decimal)'])
            else:
                df4 = pd.DataFrame(columns=['User', 'Time (decimal)'])
                errors.append("Файл 4: Файл не передан")
        except Exception as e:
            errors.append("Файл 4: Ошибка чтения CSV - " + str(e))
            df4 = pd.DataFrame(columns=['User', 'Time (decimal)'])
        
        # Создание итогового DataFrame
        result_df = df1.copy()
        result_df['Кол-во рабочих дней'] = work_days
        result_df['Остаток за позапрошлый месяц'] = 0.0
        result_df['Время без отгулов'] = 0.0
        result_df['Отгулы'] = 0.0
        result_df['Итог за текущий месяц'] = 0.0
        result_df['N (рабочие часы в месяц)'] = work_hours
        result_df['Ошибки'] = ""
        
        print("Начинаем обработку", len(result_df), "сотрудников...")
        
        # Обработка каждого сотрудника
        for idx, row in result_df.iterrows():
            employee_name = row['Имя']
            employee_errors = []
            
            # Инициализируем переменные для расчёта
            previous_balance = 0  # Остаток за позапрошлый месяц
            time_without_vacation = 0  # Время без отгулов (из файла 3)
            vacation_time = 0  # Отгулы (из файла 4)
            
            # Поиск в файле 2 (остаток за позапрошлый месяц)
            if not df2.empty and 'ФИО' in df2.columns:
                match_name, error = find_name_match(employee_name, df2['ФИО'].tolist())
                if match_name:
                    match_row = df2[df2['ФИО'] == match_name]
                    if len(match_row) == 1:
                        if 'Остаток за позапрошлый месяц' in df2.columns:
                            val = match_row.iloc[0]['Остаток за позапрошлый месяц']
                            if pd.notna(val) and val != '':
                                try:
                                    previous_balance = float(val)
                                    result_df.at[idx, 'Остаток за позапрошлый месяц'] = previous_balance
                                except ValueError:
                                    employee_errors.append("Некорректное значение остатка")
                    elif len(match_row) > 1:
                        employee_errors.append("Дублирующиеся записи в файле 2")
            
            # Поиск в файле 3 (время без отгулов)
            if not df3.empty and 'User' in df3.columns:
                match_name, error = find_name_match(employee_name, df3['User'].tolist())
                if match_name:
                    match_rows = df3[df3['User'] == match_name]
                    if len(match_rows) >= 1:
                        # Суммируем все часы для этого сотрудника
                        total_time = 0
                        for _, match_row in match_rows.iterrows():
                            if 'Time (decimal)' in df3.columns:
                                time_value = match_row['Time (decimal)']
                                if pd.notna(time_value) and time_value != '':
                                    try:
                                        total_time += float(time_value)
                                    except (ValueError, TypeError):
                                        pass
                        time_without_vacation = total_time
                        result_df.at[idx, 'Время без отгулов'] = time_without_vacation
            
            # Поиск в файле 4 (отгулы)
            if not df4.empty and 'User' in df4.columns:
                match_name, error = find_name_match(employee_name, df4['User'].tolist())
                if match_name:
                    match_rows = df4[df4['User'] == match_name]
                    if len(match_rows) >= 1:
                        # Суммируем все часы отгулов для этого сотрудника
                        total_vacation = 0
                        for _, match_row in match_rows.iterrows():
                            if 'Time (decimal)' in df4.columns:
                                vacation_value = match_row['Time (decimal)']
                                if pd.notna(vacation_value) and vacation_value != '':
                                    try:
                                        total_vacation += float(vacation_value)
                                    except (ValueError, TypeError):
                                        pass
                        vacation_time = total_vacation
                        result_df.at[idx, 'Отгулы'] = vacation_time
            
            # Расчёт итога за текущий месяц: N - Время без отгулов - Остаток за позапрошлый месяц + Отгулы
            try:
                remainder = result_df.at[idx, 'Остаток за позапрошлый месяц'] or 0
                time_worked = result_df.at[idx, 'Время без отгулов'] or 0
                time_off = result_df.at[idx, 'Отгулы'] or 0
                
                # Преобразуем в числа
                remainder = float(remainder) if pd.notna(remainder) else 0
                time_worked = float(time_worked) if pd.notna(time_worked) else 0
                time_off = float(time_off) if pd.notna(time_off) else 0
                
                total = work_hours - time_worked - remainder + time_off
                result_df.at[idx, 'Итог за текущий месяц'] = total
            except Exception as e:
                employee_errors.append("Ошибка расчёта итога: " + str(e))
            
            # Запись ошибок для сотрудника
            if employee_errors:
                result_df.at[idx, 'Ошибки'] = "; ".join(employee_errors)
        
        return result_df, errors
        
    except Exception as e:
        errors.append("Общая ошибка обработки: " + str(e))
        return None, errors

def create_csv_report(df, filename):
    """Создание CSV отчёта"""
    try:
        # Заголовки колонок
        headers = ['ФИО', 'Должность', 'Кол-во рабочих дней', 
                  'Остаток за позапрошлый месяц', 'Время без отгулов', 
                  'Отгулы', 'Итог за текущий месяц', 'N (рабочие часы в месяц)', 'Ошибки']
        
        # Подготавливаем DataFrame для экспорта
        df_export = df.copy()
        
        # Переименовываем колонку с именами
        if 'Имя' in df_export.columns:
            df_export = df_export.rename(columns={'Имя': 'ФИО'})
        
        # Убеждаемся что все нужные колонки есть
        for header in headers:
            if header not in df_export.columns:
                df_export[header] = ""
        
        # Выбираем только нужные колонки в правильном порядке
        df_export = df_export[headers]
        
        # Создаём CSV файл с точкой с запятой как разделителем для Excel
        csv_output = io.StringIO()
        df_export.to_csv(csv_output, index=False, sep=';', encoding='utf-8')
        csv_content = csv_output.getvalue()
        
        return csv_content
        
    except Exception as e:
        raise Exception("Ошибка создания CSV файла: " + str(e))
`;
            
                await pyodide.runPython(pythonCode);
                console.log('Python код загружен успешно');
                
                // Проверяем, что функции доступны
                const testResult = await pyodide.runPython(`
callable(process_files) and callable(create_csv_report)
                `);
                
                if (!testResult) {
                    throw new Error('Python функции не загружены корректно');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки Python кода:', error);
                showNotification('Ошибка загрузки Python кода: ' + error.message, 'error');
                throw error;
            }
        }

        // Обработка загрузки файлов
        async function handleFileUpload(fileNumber, input) {
            const file = input.files[0];
            if (!file) return;

            const area = document.getElementById(`file${fileNumber}-area`);
            const status = document.getElementById(`file${fileNumber}-status`);
            
            try {
                showNotification(`Загружаем файл ${fileNumber}...`, 'warning');
                
                if (file.name.endsWith('.csv') || fileNumber === 1) {
                    // CSV файлы читаем как текст
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedFiles[`file${fileNumber}`] = e.target.result;
                        
                        area.classList.add('uploaded');
                        status.style.display = 'block';
                        
                        showNotification(`Файл ${fileNumber} загружен успешно`, 'success');
                        checkReadyToProcess();
                    };
                    reader.readAsText(file);
                } else if (file.name.endsWith('.xlsx')) {
                    // Проверяем доступность конвертации XLSX
                    if (!window.xlsxConversionAvailable) {
                        throw new Error('Конвертация XLSX недоступна. Пожалуйста, сконвертируйте файл в CSV вручную или дождитесь полной инициализации.');
                    }
                    
                    // XLSX файлы конвертируем в CSV
                    showNotification(`Конвертируем XLSX файл ${fileNumber} в CSV...`, 'warning');
                    
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    const csvContent = await convertXlsxToCsv(arrayBuffer, fileNumber);
                    
                    uploadedFiles[`file${fileNumber}`] = csvContent;
                    
                    area.classList.add('uploaded');
                    status.style.display = 'block';
                    
                    showNotification(`Файл ${fileNumber} сконвертирован и загружен`, 'success');
                    checkReadyToProcess();
                } else {
                    throw new Error('Неподдерживаемый формат файла. Используйте .xlsx или .csv');
                }
            } catch (error) {
                console.error(`Ошибка загрузки файла ${fileNumber}:`, error);
                showNotification(`Ошибка загрузки файла ${fileNumber}: ${error.message}`, 'error');
            }
        }

        // Вспомогательная функция для чтения файла как ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        // Конвертация XLSX в CSV с помощью Python
        async function convertXlsxToCsv(arrayBuffer, fileNumber) {
            if (!pyodide) {
                throw new Error('Python ещё не инициализирован');
            }

            try {
                // Передаём ArrayBuffer в Python
                const uint8Array = new Uint8Array(arrayBuffer);
                pyodide.globals.set('xlsx_data', uint8Array);
                pyodide.globals.set('file_number', fileNumber);

                const csvContent = await pyodide.runPython(`
import pandas as pd
import io

try:
    # Конвертируем Uint8Array в bytes
    xlsx_bytes = bytes(xlsx_data.to_py())
    
    # Читаем Excel файл
    df = pd.read_excel(io.BytesIO(xlsx_bytes))
    
    # Применяем специфичную для файла обработку
    if file_number == 3 or file_number == 4:
        # Для файлов 3 и 4 - убираем лишние колонки и пустые строки
        df = df.dropna(subset=['User'] if 'User' in df.columns else df.columns[:1])
        if 'Time (decimal)' in df.columns and 'User' in df.columns:
            df = df[['User', 'Time (decimal)']]
    
    # Конвертируем в CSV
    csv_output = io.StringIO()
    df.to_csv(csv_output, index=False)
    csv_content = csv_output.getvalue()
    csv_content
    
except Exception as e:
    f"Ошибка конвертации XLSX в CSV: {str(e)}"
                `);

                if (csvContent.startsWith('Ошибка')) {
                    throw new Error(csvContent);
                }

                return csvContent;
                
            } catch (error) {
                throw new Error(`Не удалось сконвертировать XLSX файл: ${error.message}`);
            }
        }

        // Проверка готовности к обработке
        function checkReadyToProcess() {
            const allFilesUploaded = Object.values(uploadedFiles).every(file => file !== null);
            const processBtn = document.getElementById('process-btn');
            
            if (allFilesUploaded) {
                processBtn.disabled = false;
                updateProgress(20, 'Все файлы загружены. Готов к обработке.');
            }
        }

        // Обработка данных
        async function processData() {
            if (!pyodide) {
                showNotification('Python ещё не инициализирован', 'error');
                return;
            }

            const loadingElement = document.getElementById('loading');
            const processBtn = document.getElementById('process-btn');
            const downloadBtn = document.getElementById('download-btn');
            const errorDetails = document.getElementById('error-details');
            
            try {
                loadingElement.style.display = 'block';
                processBtn.disabled = true;
                downloadBtn.style.display = 'none';
                errorDetails.style.display = 'none';
                
                updateProgress(30, 'Начинаем обработку данных...');
                console.log('Начинаем обработку данных');

                // Проверка загруженных файлов
                const fileStatus = {
                    file1: uploadedFiles.file1 ? 'загружен' : 'отсутствует',
                    file2: uploadedFiles.file2 ? 'загружен' : 'отсутствует', 
                    file3: uploadedFiles.file3 ? 'загружен' : 'отсутствует',
                    file4: uploadedFiles.file4 ? 'загружен' : 'отсутствует'
                };
                console.log('Проверяем загруженные файлы:', fileStatus);

                // Проверяем, что все файлы загружены
                const missingFiles = [];
                if (!uploadedFiles.file1) missingFiles.push('Файл 1 (Список сотрудников)');
                if (!uploadedFiles.file2) missingFiles.push('Файл 2 (Трудозатраты прошлый месяц)');
                if (!uploadedFiles.file3) missingFiles.push('Файл 3 (Трудозатраты текущий месяц)');
                if (!uploadedFiles.file4) missingFiles.push('Файл 4 (Отгулы прошлый месяц)');

                if (missingFiles.length > 0) {
                    throw new Error('Не загружены следующие файлы:\\n' + missingFiles.join('\\n'));
                }

                // Получение параметров
                const year = document.getElementById('year-select').value;
                const month = document.getElementById('month-select').value;
                const workDays = parseInt(document.getElementById('work-days-select').value);
                const workHours = parseInt(document.getElementById('work-hours-select').value);

                console.log('Параметры:', { year, month, workDays, workHours });

                updateProgress(40, 'Загружаем файлы в Python...');

                // Передача файлов в Python (все как текст)
                pyodide.globals.set('file1_content', uploadedFiles.file1);
                pyodide.globals.set('file2_content', uploadedFiles.file2);
                pyodide.globals.set('file3_content', uploadedFiles.file3);
                pyodide.globals.set('file4_content', uploadedFiles.file4);

                updateProgress(60, 'Обрабатываем данные...');

                // Вызов Python функции
                console.log('Вызываем Python функцию process_files');
                const result = await pyodide.runPython(`
try:
    print("Начинаем обработку файлов в Python")
    print("Параметры: год=" + str(${year}) + ", месяц=${month}, дни=" + str(${workDays}) + ", часы=" + str(${workHours}))
    
    # Проверяем что файлы переданы (все как текст CSV)
    print("file1_content тип:", type(file1_content), ", длина:", len(file1_content) if file1_content else 0)
    print("file2_content тип:", type(file2_content), ", длина:", len(file2_content) if file2_content else 0)
    print("file3_content тип:", type(file3_content), ", длина:", len(file3_content) if file3_content else 0)
    print("file4_content тип:", type(file4_content), ", длина:", len(file4_content) if file4_content else 0)
    
    result_df, errors = process_files(file1_content, file2_content, file3_content, file4_content, ${year}, "${month}", ${workDays}, ${workHours})
    
    print("Обработка завершена. DataFrame:", result_df is not None, ", Ошибки:", len(errors) if errors else 0)
    
    result = (result_df.to_json(orient='records') if result_df is not None else None, errors)
    print("Результат подготовлен для передачи в JavaScript")
    
except Exception as e:
    import traceback
    error_trace = traceback.format_exc()
    print("Error in process_files:", str(e))
    print("Traceback:", error_trace)
    result = (None, ["Ошибка выполнения: " + str(e) + ". Traceback: " + error_trace])
result
                `);
                
                console.log('Python функция выполнена, результат получен');

                console.log('Тип результата Python:', typeof result);
                console.log('Результат Python:', result);

                let dataJson, errors;
                try {
                    if (result && typeof result.toJs === 'function') {
                        [dataJson, errors] = result.toJs();
                    } else {
                        // Если result не является Pyodide объектом, используем его напрямую
                        if (Array.isArray(result) && result.length === 2) {
                            [dataJson, errors] = result;
                        } else {
                            console.error('Неожиданный формат результата:', result);
                            throw new Error('Неожиданный формат результата от Python функции');
                        }
                    }
                    
                    console.log('Результат извлечён из Python:', {
                        dataJson: dataJson ? 'получен' : 'пустой',
                        dataJsonType: typeof dataJson,
                        errorsCount: errors ? errors.length : 0,
                        errorsType: typeof errors
                    });
                } catch (e) {
                    console.error('Ошибка извлечения результата:', e);
                    throw new Error('Не удалось извлечь результат из Python: ' + e.message);
                }
                
                updateProgress(80, 'Формируем CSV отчёт...');

                if (dataJson && dataJson !== 'None' && dataJson !== null) {
                    processedData = JSON.parse(dataJson);
                    
                    // Создание CSV файла
                    const filename = `Отчет по трудозатратам ${month}_${year}.csv`;
                    
                    // Передаём DataFrame обратно в Python для создания CSV
                    pyodide.globals.set('data_json', dataJson);
                    pyodide.globals.set('report_filename', filename);
                    
                    await pyodide.runPython(`
try:
    import pandas as pd
    import json
    data = json.loads(data_json)
    df_for_csv = pd.DataFrame(data)
    csv_content = create_csv_report(df_for_csv, report_filename)
    print("CSV report created successfully, length:", len(csv_content))
except Exception as e:
    import traceback
    print("Error creating CSV:", str(e))
    print("Traceback:", traceback.format_exc())
    csv_content = None
                    `);
                    
                    const csvData = pyodide.globals.get('csv_content');
                    
                    // Сохранение данных для скачивания
                    window.reportData = {
                        data: csvData,
                        filename: filename
                    };
                    
                    updateProgress(100, 'Обработка завершена успешно!');
                    
                    downloadBtn.style.display = 'inline-flex';
                    downloadBtn.disabled = false;
                    
                    showNotification('Данные обработаны успешно!', 'success');
                } else {
                    console.error('dataJson пустой или null:', {
                        dataJson: dataJson,
                        errors: errors,
                        rawResult: result
                    });
                    
                    let errorMessage = 'Не удалось обработать данные';
                    if (errors && errors.length > 0) {
                        errorMessage += ':\n' + errors.join('\n');
                    } else {
                        errorMessage += '. Python функция вернула пустой результат.';
                    }
                    
                    throw new Error(errorMessage);
                }

                // Показ ошибок, если есть
                if (errors && errors.length > 0) {
                    currentErrors = errors;
                    displayErrors(errors);
                    showNotification(`Обработка завершена с ${errors.length} предупреждениями`, 'warning');
                }

            } catch (error) {
                console.error('Ошибка обработки:', error);
                
                // Показываем подробную ошибку
                let detailedError = error.message;
                if (error.stack) {
                    detailedError += '\n\nStack trace:\n' + error.stack;
                }
                
                showNotification('Подробная ошибка при обработке данных:\n\n' + detailedError, 'error');
                updateProgress(0, 'Ошибка обработки данных');
                
                // Также показываем ошибку в секции ошибок
                if (currentErrors.length === 0) {
                    currentErrors.push(detailedError);
                }
                displayErrors(currentErrors);
                
            } finally {
                loadingElement.style.display = 'none';
                processBtn.disabled = false;
            }
        }

        // Скачивание отчёта
        function downloadReport() {
            if (!window.reportData) {
                showNotification('Нет данных для скачивания', 'error');
                return;
            }

            try {
                // Добавляем BOM для корректного отображения кириллицы в Excel
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + window.reportData.data;
                
                // Создание Blob из CSV строки
                const blob = new Blob([csvWithBOM], {
                    type: 'text/csv;charset=utf-8'
                });

                // Создание ссылки для скачивания
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.reportData.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('CSV файл скачан успешно!', 'success');
            } catch (error) {
                console.error('Ошибка скачивания:', error);
                showNotification('Ошибка при скачивании файла: ' + error.message, 'error');
            }
        }

        // Обновление прогресс-бара
        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // Показ ошибок
        function displayErrors(errors) {
            const errorDetails = document.getElementById('error-details');
            const errorList = document.getElementById('error-list');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorDetails.style.display = 'block';
        }

        // Функции для Error Footer
        function showErrorFooter(errorMessage) {
            const footer = document.getElementById('error-footer');
            const content = document.getElementById('error-footer-content');
            
            content.textContent = errorMessage;
            footer.classList.add('show');
            
            // Сохраняем ошибку для копирования
            window.lastError = errorMessage;
        }

        function hideErrorFooter() {
            const footer = document.getElementById('error-footer');
            footer.classList.remove('show');
        }

        function copyErrorToClipboard() {
            if (window.lastError) {
                navigator.clipboard.writeText(window.lastError).then(() => {
                    showNotification('Ошибка скопирована в буфер обмена', 'success');
                }).catch(() => {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = window.lastError;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('Ошибка скопирована в буфер обмена', 'success');
                });
            }
        }

        // Уведомления
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Вычисляем позицию для нового уведомления
            const existingNotifications = document.querySelectorAll('.notification.show');
            let topPosition = 20;
            existingNotifications.forEach(existing => {
                topPosition += existing.offsetHeight + 10;
            });
            notification.style.top = topPosition + 'px';
            
            // Создаём контент и кнопку закрытия
            const content = document.createElement('div');
            content.className = 'notification-content';
            content.style.whiteSpace = 'pre-wrap'; // Для правильного отображения переносов строк
            content.textContent = message;
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.alignItems = 'center';
            
            // Кнопка копирования (только для ошибок)
            if (type === 'error') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'notification-copy';
                copyBtn.innerHTML = '📋';
                copyBtn.title = 'Копировать ошибку';
                                        copyBtn.onclick = () => {
                    navigator.clipboard.writeText(message).then(() => {
                        copyBtn.innerHTML = '✓';
                        setTimeout(() => {
                            copyBtn.innerHTML = '📋';
                        }, 1000);
                    });
                };
                
                // Для ошибок также показываем footer
                copyBtn.ondblclick = () => {
                    showErrorFooter(message);
                };
                buttonsContainer.appendChild(copyBtn);
            }
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'notification-close';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = () => closeNotification(notification);
            buttonsContainer.appendChild(closeBtn);
            
            notification.appendChild(content);
            notification.appendChild(buttonsContainer);
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Для ошибок - не закрываем автоматически
            if (type !== 'error') {
                setTimeout(() => {
                    closeNotification(notification);
                }, 5000); // Увеличил время до 5 секунд для других типов
            } else {
                // Для длинных ошибок автоматически показываем footer
                if (message.length > 200) {
                    setTimeout(() => {
                        showErrorFooter(message);
                    }, 500); // Показываем footer через полсекунды для ошибок
                }
            }
        }

        // Закрытие уведомления
        function closeNotification(notification) {
            if (notification && notification.parentNode) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Сохранение в LocalStorage
        function saveToLocalStorage() {
            const params = {
                year: document.getElementById('year-select').value,
                month: document.getElementById('month-select').value,
                workDays: document.getElementById('work-days-select').value,
                workHours: document.getElementById('work-hours-select').value,
                timestamp: Date.now()
            };
            
            localStorage.setItem('workAnalysisParams', JSON.stringify(params));
        }

        // Загрузка из LocalStorage
        function loadFromLocalStorage() {
            const stored = localStorage.getItem('workAnalysisParams');
            if (!stored) return;
            
            try {
                const params = JSON.parse(stored);
                const twoHours = 2 * 60 * 60 * 1000; // 2 часа в миллисекундах
                
                // Проверка срока действия
                if (Date.now() - params.timestamp > twoHours) {
                    localStorage.removeItem('workAnalysisParams');
                    return;
                }
                
                // Восстановление значений
                document.getElementById('year-select').value = params.year;
                document.getElementById('month-select').value = params.month;
                document.getElementById('work-days-select').value = params.workDays;
                document.getElementById('work-hours-select').value = params.workHours;
                
            } catch (error) {
                console.error('Ошибка загрузки из LocalStorage:', error);
                localStorage.removeItem('workAnalysisParams');
            }
        }

        // Очистка LocalStorage при закрытии страницы
        window.addEventListener('beforeunload', function() {
            // LocalStorage остается для следующего визита в течение 2 часов
        });
    </script>
</body>
</html>
